name: Comment Reply Automation

permissions:
  contents: read
  pull-requests: write
  issues: write

on:
  issue_comment:
    types: [created, edited]
  pull_request_review_comment:
    types: [created, edited]

jobs:
  reply-to-badge-comments:
    runs-on: ubuntu-latest
    # 注意: フォークPRのコメントでもこのジョブは実行されますが、
    # secrets.PAT_TOKENにアクセスできないため失敗します。
    # issue_comment/pull_request_review_commentイベントでは
    # フォーク判定が複雑なため、現状は失敗を許容しています。

    steps:
      - name: Checkout repository
        if: ${{ github.event.comment && (contains(github.event.comment.body, 'P1 Badge') || contains(github.event.comment.body, 'P2 Badge') || contains(github.event.comment.body, 'P3 Badge')) }}
        uses: actions/checkout@v4

      - name: Badge付きコメントに返信
        if: ${{ github.event.comment && (contains(github.event.comment.body, 'P1 Badge') || contains(github.event.comment.body, 'P2 Badge') || contains(github.event.comment.body, 'P3 Badge')) }}
        uses: actions/github-script@v7
        with:
          # Personal Access Tokenを使用してCodexをトリガー
          # GITHUB_TOKENではCodexが反応しないため、PATが必要
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const script = require('./.github/scripts/reply-to-badge-comment.js');
            await script({ github, context });
