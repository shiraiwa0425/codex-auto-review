name: codex review CI
permissions:
  contents: write
  pull-requests: write
  issues: write
on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created, edited]
  # 必要なら pull_request_review_comment も追加
  pull_request_review_comment:
    types: [created, edited]

jobs:
  test-do-it-go-gogo:
    runs-on: ubuntu-latest

    steps:
      - name: one step umm say hello world!
        run: console.log('hello world');
        shell: node {0}

      - name: codexにレビュー依頼のリプライ
        if: ${{ github.event.comment && (contains(github.event.comment.body, 'P1 Badge') || contains(github.event.comment.body, 'P2 Badge') || contains(github.event.comment.body, 'P3 Badge')) }}
        uses: actions/github-script@v7
        with:
          script: |
            // PRレビューコメントかどうかを判定
            const isPullRequestReviewComment = context.payload.comment.pull_request_review_id;

            // リアクションを追加
            if (isPullRequestReviewComment) {
              // PRレビューコメントの場合
              await github.rest.reactions.createForPullRequestReviewComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'eyes'
              });
            } else {
              // 通常のissueコメントの場合
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'eyes'
              });
            }

            // コメントを投稿
            if (isPullRequestReviewComment) {
              // PRレビューコメントの場合はスレッド返信
              await github.rest.pulls.createReplyForReviewComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                comment_id: context.payload.comment.id,
                body: '@codex コメントを対応してください'
              });
            } else {
              // 通常のissueコメントの場合は新規コメント
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: '@codex コメントを対応してください'
              });
            }
    # strategy:
    #   matrix:
    #     node-version: [18.x, 20.x]

    # steps:
    #   - name: Checkout code
    #     uses: actions/checkout@v4

    #   - name: Setup Node.js ${{ matrix.node-version }}
    #     uses: actions/setup-node@v4
    #     with:
    #       node-version: ${{ matrix.node-version }}
    #       cache: "npm"

    #   - name: Install dependencies
    #     run: npm ci

    #   - name: Run linter
    #     run: npm run lint
    #     continue-on-error: true

    #   - name: Run tests
    #     run: npm test
    #     continue-on-error: true

    #   - name: Build
    #     run: npm run build
    #     continue-on-error: true
